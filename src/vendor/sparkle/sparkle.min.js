
(function(window){var SparkleEmitter=function(canvas){this.context=canvas.getContext('2d');this.particles=[];this.debug=false;this.position={x:canvas.width/2,y:canvas.height/2};this.gravity=0;this.fireDuration=0;this.radius=45;this.direction=-90;this.maxParticles=999999;this.size={width:1,height:1};this.particlesPerSecond=60;this.particle={default:{speed:150,size:10,lifetime:2,spin:0,gravity:0},max:{speed:0,size:0,lifetime:0,spin:0,gravity:0}};this.lifetime=0;this.numNewParticles=0;this.startSecond=this.getTime();this.currentSecond=this.getTime();this.pastSecond=this.getTime();this.deltaSecond=1;this.createParticles=true;this.isAlive=true;};SparkleEmitter.prototype.PARTICLE_BORN=1;SparkleEmitter.prototype.PARTICLE_LIVING=2;SparkleEmitter.prototype.PARTICLE_DIEING=3;SparkleEmitter.prototype.PARTICLE_DEAD=0;SparkleEmitter.prototype.PI_180=Math.PI/180;SparkleEmitter.prototype.getTime=function(){if(window.performance&&window.performance.now){return performance.now()+performance.timing.navigationStart;}else{return Date.now();}};SparkleEmitter.prototype.setSize=function(width,height){this.size={width:width,height:height};return this;};SparkleEmitter.prototype.setParticlesPerSecond=function(count){this.particlesPerSecond=count;return this;};SparkleEmitter.prototype.setGravity=function(pixelPerSecond){this.gravity=pixelPerSecond;return this;};SparkleEmitter.prototype.setMaxParticles=function(max){this.maxParticles=max;return this;};SparkleEmitter.prototype.setParticleSpeed=function(pixelsPerSecond,max){if(max)
this.particle.max.speed=max;this.particle.default.speed=pixelsPerSecond;return this;};SparkleEmitter.prototype.setParticleSpin=function(degreePerSecond,max){if(max)
this.particle.max.spin=max;this.particle.default.spin=degreePerSecond;return this;};SparkleEmitter.prototype.setParticleSize=function(pixel,max){if(max)
this.particle.max.size=max;this.particle.default.size=pixel;return this;};SparkleEmitter.prototype.setParticleLifetime=function(seconds,max){if(max)
this.particle.max.lifetime=max;this.particle.default.lifetime=seconds;return this;};SparkleEmitter.prototype.setFireDuration=function(duration){this.fireDuration=duration;return this;};SparkleEmitter.prototype.setRadius=function(radius){this.radius=radius;return this;};SparkleEmitter.prototype.setDirection=function(direction){this.direction=direction;return this;};SparkleEmitter.prototype.setPosition=function(position){this.position=position;return this;};SparkleEmitter.prototype.getPosition=function(){return this.position;};SparkleEmitter.prototype.randomBetween=function(start,end){return Math.floor(Math.random()*(end-start+1)+start);};SparkleEmitter.prototype.getParticleAge=function(particle){return this.currentSecond-particle.born;};SparkleEmitter.prototype.initialParticleLifetime=function(){if(this.particle.max.lifetime>0){return this.randomBetween(this.particle.default.lifetime,this.particle.max.lifetime);}else{return this.particle.default.lifetime;}};SparkleEmitter.prototype.initialParticleSize=function(){if(this.particle.max.size>0){return this.randomBetween(this.particle.default.size,this.particle.max.size);}else{return this.particle.default.size;}};SparkleEmitter.prototype.initialParticleDirection=function(){var halfRadius=this.radius/2,left=this.direction-halfRadius,right=this.direction+halfRadius;return this.randomBetween(left,right);};SparkleEmitter.prototype.initialParticleSpeed=function(){if(this.particle.max.speed>0){return this.randomBetween(this.particle.default.speed,this.particle.max.speed);}else{return this.particle.default.speed;}};SparkleEmitter.prototype.initialParticleSpin=function(){if(this.particle.max.spin>0){return this.randomBetween(this.particle.default.spin,this.particle.max.spin);}else{return this.particle.default.spin;}};SparkleEmitter.prototype.initialParticleRotation=function(){if(this.particle.default.spin>0){return this.randomBetween(0,360);}
return 0;};SparkleEmitter.prototype.initialParticlePosition=function(){if(this.size.width>1||Â this.size.height>1){var halfWidth=this.size.width/2,halfHeight=this.size.height/2;return{x:this.randomBetween(this.position.x-halfWidth,this.position.x+halfWidth),y:this.randomBetween(this.position.y-halfHeight,this.position.y+halfHeight)};}
return this.position;};SparkleEmitter.prototype.applyParticleVelocity=function(particle){var radians=particle.direction*this.PI_180;particle.velocity.x=Math.cos(radians)*particle.speed;particle.velocity.y=Math.sin(radians)*particle.speed;return this;};SparkleEmitter.prototype.attachParticleProperties=function(particle){return this;};SparkleEmitter.prototype.modifyParticle=function(particle){particle.x+=particle.velocity.x*this.deltaSecond;particle.y+=particle.velocity.y*this.deltaSecond;particle.velocity.y+=this.gravity*this.deltaSecond;particle.rotation+=particle.spin;switch(particle.lifecycle){case this.PARTICLE_BORN:particle.opacity+=0.2;break;case this.PARTICLE_LIVING:break;case this.PARTICLE_DIEING:particle.opacity-=0.05;break;}
return this;};SparkleEmitter.prototype.particleLifecycle=function(particle){if(particle.lifecycle>=this.PARTICLE_BORN){if(particle.opacity>=1&&particle.lifecycle===this.PARTICLE_BORN){particle.lifecycle=this.PARTICLE_LIVING;}
if(this.getParticleAge(particle)>=particle.lifetime&&particle.lifecycle===this.PARTICLE_LIVING){particle.lifecycle=this.PARTICLE_DIEING;}
if(particle.opacity<=0&&particle.lifecycle===this.PARTICLE_DIEING){particle.lifecycle=this.PARTICLE_DEAD;}}
return particle.lifecycle;};SparkleEmitter.prototype.renderParticles=function(){if(this.particles.length>0){for(var iteration=0;iteration<this.particles.length;iteration++){var particle=this.particles[iteration];if(particle.lifecycle>=this.PARTICLE_BORN){this.renderParticle(particle);this.modifyParticle(particle);this.particleLifecycle(particle);particle.frame++;}}}
for(var iteration=0;iteration<this.particles.length;iteration++){if(!this.particles[iteration].lifecycle){this.particles.splice(iteration,1);}}
return this;};SparkleEmitter.prototype.renderParticle=function(particle){this.context.save();var particleCenter=(particle.size/2),centerX=particle.x-particleCenter,centerY=particle.y-particleCenter;this.context.globalAlpha=particle.opacity;this.context.translate(centerX,centerY);this.context.translate(particleCenter,particleCenter);this.context.rotate(particle.rotation*this.PI_180);this.drawParticle(-particleCenter,-particleCenter,particle);if(this.debug){this.context.font="8px sans-serif";this.context.fillText(particle.speed,particle.x+particle.size+2,particle.y);}
this.context.restore();return this;};SparkleEmitter.prototype.drawParticle=function(x,y,particle){this.context.beginPath();this.context.arc(x,y,particle.size/2,0,Math.PI*2);this.context.fillStyle='#fff';this.context.fill();return this;};SparkleEmitter.prototype.addParticles=function(){this.numNewParticles+=this.particlesPerSecond*this.deltaSecond;if(this.numNewParticles>1){for(var iteration=0;iteration<this.numNewParticles;iteration++){this.addParticle();}
this.numNewParticles=0;}
return this;};SparkleEmitter.prototype.addParticle=function(){var position=this.initialParticlePosition();var newParticle={x:position.x,y:position.y,born:this.currentSecond,lifecycle:this.PARTICLE_BORN,frame:0,opacity:0,direction:this.initialParticleDirection(),speed:this.initialParticleSpeed(),lifetime:this.initialParticleLifetime()*1000,size:this.initialParticleSize(),spin:this.initialParticleSpin(),rotation:this.initialParticleRotation(),velocity:{x:0,y:0}};this.attachParticleProperties(newParticle).applyParticleVelocity(newParticle);this.particles.push(newParticle);return this;};SparkleEmitter.prototype.fire=function(timestamp){this.currentSecond=this.getTime();this.deltaSecond=(this.currentSecond-this.pastSecond)/1000;this.lifetime=(this.currentSecond-this.startSecond)/1000;if(this.fireDuration>0){this.createParticles=this.fireDuration>=this.lifetime;}
if(this.particles.length<this.maxParticles&&this.createParticles){this.addParticles();}
this.renderParticles();if(this.createParticles===false&&this.particles.length===0){this.isAlive=false;}
this.pastSecond=this.currentSecond;return this;};window.SparkleEmitter=SparkleEmitter;})(window);